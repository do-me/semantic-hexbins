<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full-Text Search Benchmark in JS Without Index</title>
    <style>
        /* --- Base Styles, Container, Header, p, hr --- */
        :root { /* ... colors etc ... */
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745; --warning-color: #ffc107; --danger-color: #dc3545; --light-color: #f8f9fa; --dark-color: #343a40; --border-color: #dee2e6; --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; --border-radius: 0.25rem;
        }
        body { /* ... basic body styles ... */
            font-family: var(--font-family-sans-serif); line-height: 1.6; background-color: var(--light-color); color: var(--dark-color); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh;
        }
        .container { /* ... container styles ... */
             width: 90%; max-width: 800px; margin: 20px auto; background-color: #fff; padding: 30px; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex-grow: 1;
        }
        header h1 { /* ... header styles ... */
             color: var(--dark-color); text-align: center; margin-bottom: 20px;
        }
        p { margin-bottom: 1rem; }
        hr { border: 0; border-top: 1px solid var(--border-color); margin: 1.5rem 0; }

        /* --- Button Styles --- */
        button#runTestButton { /* ... styles as before ... */
            display: block; width: 100%; padding: 12px 20px; font-size: 1.1em; font-weight: bold; color: #fff; background-color: var(--primary-color); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, opacity 0.2s ease; margin-top: 20px;
        }
        button#runTestButton:hover:not(:disabled) { background-color: #0056b3; }
        button#runTestButton:disabled { background-color: var(--secondary-color); cursor: not-allowed; opacity: 0.7; }

        /* Download Button Style */
        button#downloadDataCsvButton {
            padding: 8px 15px;
            font-size: 0.9em;
            color: var(--primary-color);
            background-color: transparent;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            margin-top: 15px; /* Spacing from table */
            display: block; /* Make it block level */
            width: fit-content; /* Size to content */
        }
        button#downloadDataCsvButton:hover:not(:disabled) {
            background-color: var(--primary-color);
            color: #fff;
        }
        button#downloadDataCsvButton:disabled {
             color: var(--secondary-color);
             border-color: var(--secondary-color);
             cursor: not-allowed;
             opacity: 0.7;
        }

        /* --- Sections & Configuration --- */
         .config-section, .results-section, .samples-section { margin-bottom: 25px; }
         .config-section h2, .results-section h2, .samples-section h2 { /* ... section header styles ... */
             margin-bottom: 15px; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;
         }
        .slider-container { /* ... slider styles ... */
             display: flex; align-items: center; margin-bottom: 10px; gap: 10px;
        }
        .slider-container label { flex-basis: 120px; text-align: right; font-weight: bold; font-size: 0.9em; } /* Adjusted flex-basis */
        .slider-container input[type="range"] { flex-grow: 1; cursor: pointer; }
        .slider-container output { font-weight: bold; min-width: 30px; text-align: right; background-color: var(--light-color); padding: 2px 6px; border-radius: var(--border-radius); font-size: 0.9em; }

         /* Input Field Configuration Style */
         .input-container {
             display: flex;
             align-items: center;
             margin-bottom: 10px;
             gap: 10px;
         }
         .input-container label {
             flex-basis: 120px;
             text-align: right;
             font-weight: bold;
             font-size: 0.9em;
         }
         .input-container input[type="number"] {
             flex-grow: 1;
             padding: 8px;
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
             font-size: 0.9em;
         }

        /* --- Status & Results Styling --- */
        /* #progress Div kept for initial/final status, removed intense styling */
        #statusMessage {
             font-style: italic; color: var(--secondary-color);
             padding: 10px; border-radius: var(--border-radius); margin-top: 15px;
             min-height: 1.5em; text-align: center;
        }
        #results { /* ... results div styles ... */
             margin-top: 10px; padding: 15px; border: 1px solid var(--border-color); background-color: var(--light-color); border-radius: var(--border-radius); word-wrap: break-word;
        }
        #results p { margin-bottom: 0.5rem; line-height: 1.4; } /* Compact results */
        #results p:last-child { margin-bottom: 0; }
        #results strong { /* ... strong tag styles ... */
             display: inline-block; min-width: 190px; color: var(--dark-color); font-weight: 600;
        }
        #results .note { font-size: 0.85em; color: var(--secondary-color); margin-top: 0.8rem; }

        /* --- Samples Table Styling --- */
        #samplesContainer {
            margin-top: 15px;
            max-height: 250px; /* Limit height and add scroll */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        #samplesTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        #samplesTable th, #samplesTable td {
            border: 1px solid var(--border-color);
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }
        #samplesTable th {
            background-color: var(--light-color);
            position: sticky; /* Keep header visible on scroll */
            top: 0;
            z-index: 1;
        }
        #samplesTable td:nth-child(1), /* Lat */
        #samplesTable td:nth-child(2), /* Lon */
        #samplesTable td:nth-child(3) { /* ID */
            white-space: nowrap; /* Prevent wrapping */
        }
        #samplesTable td:nth-child(4) { /* Text */
             word-break: break-word; /* Allow long text to wrap */
        }

        /* --- Messages & Footer --- */
        .warning { /* ... warning styles ... */
             color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: var(--border-radius); font-weight: bold;
        }
        .info { color: var(--primary-color); font-weight: bold; }
        .error { color: var(--danger-color); font-weight: bold; }
        footer { /* ... footer styles ... */
             text-align: center; margin-top: auto; padding: 15px; font-size: 0.85em; color: var(--secondary-color); background-color: #e9ecef;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Full-Text Search Benchmark in JS Without Index</h1>
        </header>

        <p>
            This page runs a benchmark on randomly generated structured data (Text, Lat, Lon, Location ID).
            Adjust the number of test data rows, text word count range, and number of search repetitions below.
        </p>
        <p class="warning">
            ⚠️ Warning: Generating and searching a large number of entries is memory/CPU intensive.
            The page might freeze during the test. Downloading the full CSV dataset will also be large.
        </p>

        <section class="config-section">
             <h2>Configuration</h2>

             <!-- Number of Rows Input -->
             <div class="input-container">
                 <label for="numRows">Number of Rows:</label>
                 <input type="number" id="numRows" name="numRows" min="1" max="1000000" value="693959" step="1000">
             </div>

             <!-- Text Length Sliders -->
             <div class="slider-container">
                 <label for="minWords">Min Words (Text):</label>
                 <input type="range" id="minWords" name="minWords" min="1" max="199" value="3" step="1">
                 <output for="minWords" id="minWordsOutput">3</output>
             </div>
             <div class="slider-container">
                 <label for="maxWords">Max Words (Text):</label>
                 <input type="range" id="maxWords" name="maxWords" min="2" max="10000" value="30" step="1">
                 <output for="maxWords" id="maxWordsOutput">30</output>
             </div>
             <!-- Search Repetitions Slider -->
             <div class="slider-container">
                <label for="searchReps">Search Repetitions:</label>
                <input type="range" id="searchReps" name="searchReps" min="1" max="1000" value="10" step="1">
                <output for="searchReps" id="searchRepsOutput">10</output>
            </div>
             <button id="runTestButton">Run Benchmark</button>
        </section>

        <!-- Status message div - kept for initial/final messages -->
        <div id="statusMessage">Ready. Click the button to start.</div>

        <section class="results-section" style="display: none;">
            <h2>Benchmark Results</h2>
            <div id="results"></div> <!-- Results will be injected here -->
        </section>

        <section class="samples-section" style="display: none;">
            <h2>Sample Generated Data (First 5)</h2>
            <!-- Table Structure -->
            <div id="samplesContainer">
                <table id="samplesTable">
                    <thead>
                        <tr>
                            <th>Lat</th>
                            <th>Lon</th>
                            <th>Location ID</th>
                            <th>Text</th>
                        </tr>
                    </thead>
                    <tbody id="samplesTableBody"></tbody>
                </table>
            </div>
            <!-- Download Button -->
            <button id="downloadDataCsvButton" style="display: none;">Download Full Sample Data (CSV)</button>
        </section>

    </div>

    <footer>
        Note: Simulates a basic search repeated multiple times on the same data. Real systems use indexing. CSV export includes Lat, Lon, Location ID, Text. Times are in milliseconds (ms).
    </footer>

    <script>
        // --- DOM Elements ---
        const runTestButton = document.getElementById('runTestButton');
        const resultsDiv = document.getElementById('results');
        const statusMessageDiv = document.getElementById('statusMessage'); // Renamed for clarity
        const samplesTableBody = document.getElementById('samplesTableBody');
        const resultsSection = document.querySelector('.results-section');
        const samplesSection = document.querySelector('.samples-section'); 
        const minWordsSlider = document.getElementById('minWords');
        const maxWordsSlider = document.getElementById('maxWords');
        const searchRepsSlider = document.getElementById('searchReps');
        const minWordsOutput = document.getElementById('minWordsOutput');
        const maxWordsOutput = document.getElementById('maxWordsOutput');
        const searchRepsOutput = document.getElementById('searchRepsOutput');
        const downloadDataCsvButton = document.getElementById('downloadDataCsvButton');
        const numRowsInput = document.getElementById('numRows');

        // --- Configuration ---
        let NUM_ENTRIES = parseInt(numRowsInput.value, 10);
        const SEARCH_TERM = "social";
        const VOCABULARY = ["the", "a", "is", "of", "and", "to", "in", "it", "that", "this", "post", "like", "share", "comment", "user", "test", "data", "hello", "world", "quick", "brown", "fox", "jumps", "over", "lazy", "dog", "social", "media", "update", "status", "random", "text", "example", "search", "query", "performance", "entry", "some", "more", "words", "for", "variety", "browser", "javascript", "code", "run", "simple", "algorithm", "benchmark", "performance", "speed", "cpu", "memory", "database", "index", "querying"];

        // --- State Variables ---
        let generatedData = null;
        let currentMinWords = parseInt(minWordsSlider.value, 10);
        let currentMaxWords = parseInt(maxWordsSlider.value, 10);
        let currentSearchReps = parseInt(searchRepsSlider.value, 10);

        // --- Slider Logic ---
        minWordsOutput.textContent = currentMinWords;
        maxWordsOutput.textContent = currentMaxWords;
        searchRepsOutput.textContent = currentSearchReps;

        minWordsSlider.oninput = function() {
            currentMinWords = parseInt(this.value, 10);
            minWordsOutput.textContent = currentMinWords;
            if (currentMinWords >= currentMaxWords) {
                currentMaxWords = currentMinWords + 1;
                if (currentMaxWords > parseInt(maxWordsSlider.max, 10)) {
                    currentMaxWords = parseInt(maxWordsSlider.max, 10);
                    if (currentMinWords >= currentMaxWords) {
                         currentMinWords = currentMaxWords -1;
                         this.value = currentMinWords;
                         minWordsOutput.textContent = currentMinWords;
                    }
                }
                maxWordsSlider.value = currentMaxWords;
                maxWordsOutput.textContent = currentMaxWords;
            }
        };

        maxWordsSlider.oninput = function() {
            currentMaxWords = parseInt(this.value, 10);
            maxWordsOutput.textContent = currentMaxWords;
            if (currentMaxWords <= currentMinWords) {
                currentMinWords = currentMaxWords - 1;
                if (currentMinWords < parseInt(minWordsSlider.min, 10)) {
                    currentMinWords = parseInt(minWordsSlider.min, 10);
                    if (currentMaxWords <= currentMinWords) {
                        currentMaxWords = currentMinWords + 1;
                        this.value = currentMaxWords;
                        maxWordsOutput.textContent = currentMaxWords;
                    }
                }
                minWordsSlider.value = currentMinWords;
                minWordsOutput.textContent = currentMinWords;
            }
        };

        searchRepsSlider.oninput = function() {
            currentSearchReps = parseInt(this.value, 10);
            searchRepsOutput.textContent = currentSearchReps;
        };

        numRowsInput.onchange = function() {
            NUM_ENTRIES = parseInt(this.value, 10);
            if (isNaN(NUM_ENTRIES) || NUM_ENTRIES < 1) {
                NUM_ENTRIES = 1;
                this.value = 1;
            }
        };

        // --- Helper Functions ---
        function generateRandomText(minWords, maxWords, vocabulary) {
             const actualMin = Math.min(minWords, maxWords);
             const actualMax = Math.max(minWords, maxWords);
             const numWords = Math.floor(Math.random() * (actualMax - actualMin + 1)) + actualMin;
             let text = [];
             for (let i = 0; i < numWords; i++) {
                 const randomIndex = Math.floor(Math.random() * vocabulary.length);
                 text.push(vocabulary[randomIndex]);
             }
             return text.join(" ");
        }
        function generateRandomLat() { return (Math.random() * 180 - 90).toFixed(5); }
        function generateRandomLon() { return (Math.random() * 360 - 180).toFixed(5); }
        function generateRandomLocationId() { let id = ''; for (let i = 0; i < 10; i++) { id += Math.floor(Math.random() * 10); } return id; }
        function escapeCsvField(field) {
             if (field === null || field === undefined) { return ''; }
             const stringField = String(field);
             if (stringField.includes(',') || stringField.includes('\n') || stringField.includes('"')) {
                 const escapedField = stringField.replace(/"/g, '""');
                 return `"${escapedField}"`;
             }
             return stringField;
        }

        // --- Download Function (CSV) ---
        function downloadDataAsCsv() {
            if (!generatedData || generatedData.length === 0) { alert('No data generated.'); return; }
            // No progress update here
            downloadDataCsvButton.disabled = true;

            setTimeout(() => { // Use timeout to allow UI to update button state slightly
                try {
                    const csvHeader = "lat,lon,location_id,text\n";
                    const csvRows = generatedData.map(item =>
                        `${item.lat},${item.lon},${item.location_id},${escapeCsvField(item.text)}`
                    );
                    const csvString = csvHeader + csvRows.join("\n");
                    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `benchmark_data_${generatedData.length}_entries.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    // No success message update here
                } catch (e) {
                    console.error("Error creating CSV download file:", e);
                    // No error message update here, use alert
                    alert('Failed to prepare download.');
                } finally {
                    downloadDataCsvButton.disabled = false;
                    // No progress message reset needed
                }
            }, 10);
        }

        // --- Main Benchmark Function ---
        function runBenchmark() {
            // --- UI Updates Start ---
            generatedData = null; // Clear previous data
            resultsDiv.innerHTML = '';
            samplesTableBody.innerHTML = '';
            resultsSection.style.display = 'none';
            samplesSection.style.display = 'none';
            downloadDataCsvButton.style.display = 'none';
            downloadDataCsvButton.disabled = true;
            statusMessageDiv.innerHTML = '<span class="info">Running benchmark... Please wait (UI may freeze).</span>';
            runTestButton.disabled = true;
            minWordsSlider.disabled = true;
            maxWordsSlider.disabled = true;
            searchRepsSlider.disabled = true;
            numRowsInput.disabled = true;

            setTimeout(() => { // Timeout allows UI to update before heavy lifting
                let dataBuffer = [];
                let actualNumEntries = 0;
                let generationDuration = 0; // In ms
                let generationError = null;
                let searchDurations = []; // Array to store individual search times (in ms)
                let totalSearchTime = 0; // In ms
                let minSearchTime = Infinity; // In ms
                let maxSearchTime = 0; // In ms
                let avgSearchTime = 0; // In ms
                let totalMatchesFound = 0;

                const minW = currentMinWords;
                const maxW = currentMaxWords;
                const reps = currentSearchReps;
                NUM_ENTRIES = parseInt(numRowsInput.value, 10);

                try {
                    // --- Data Generation ---
                    // No progress updates during generation
                    const genStartTime = performance.now();
                    for (let i = 0; i < NUM_ENTRIES; i++) {
                        dataBuffer.push({
                            lat: generateRandomLat(),
                            lon: generateRandomLon(),
                            location_id: generateRandomLocationId(),
                            text: generateRandomText(minW, maxW, VOCABULARY)
                        });
                        // Removed intermittent progress update
                    }
                    actualNumEntries = dataBuffer.length;
                    generatedData = dataBuffer;
                    const genEndTime = performance.now();
                    generationDuration = genEndTime - genStartTime; // Keep in ms
                    // No progress update after generation

                    // Display samples & Show/Enable Download Button
                    if (actualNumEntries > 0) {
                         samplesSection.style.display = 'block';
                         const sampleCount = Math.min(5, actualNumEntries);
                         samplesTableBody.innerHTML = ''; // Clear previous samples
                         for(let i = 0; i < sampleCount; i++) {
                             const item = generatedData[i];
                             const row = samplesTableBody.insertRow();
                             row.insertCell(0).textContent = item.lat;
                             row.insertCell(1).textContent = item.lon;
                             row.insertCell(2).textContent = item.location_id;
                             row.insertCell(3).textContent = item.text;
                         }
                         downloadDataCsvButton.style.display = 'block';
                         downloadDataCsvButton.disabled = false;
                     }

                } catch (e) {
                    // --- Error Handling ---
                    generationError = e;
                    console.error("Error during data generation:", e);
                    actualNumEntries = dataBuffer.length;
                    generatedData = dataBuffer; // Keep potentially partial data
                    // No error progress update here

                    if (actualNumEntries === 0) {
                         resultsSection.style.display = 'block';
                         resultsDiv.innerHTML = `<p class="error"><strong>Error:</strong> Failed to generate any data.</p><p>Details: ${e.message}</p>`;
                         statusMessageDiv.innerHTML = '<span class="error">Benchmark failed: No data generated.</span>'; // Final status
                         runTestButton.disabled = false;
                         minWordsSlider.disabled = false;
                         maxWordsSlider.disabled = false;
                         searchRepsSlider.disabled = false;
                         numRowsInput.disabled = false;
                         generatedData = null;
                         return; // Stop benchmark
                    } else {
                        // Show samples even if generation failed partially
                         samplesSection.style.display = 'block';
                         const sampleCount = Math.min(5, actualNumEntries);
                         samplesTableBody.innerHTML = '';
                         for(let i = 0; i < sampleCount; i++) {
                             const item = generatedData[i];
                             const row = samplesTableBody.insertRow();
                             row.insertCell(0).textContent = item.lat;
                             row.insertCell(1).textContent = item.lon;
                             row.insertCell(2).textContent = item.location_id;
                             row.insertCell(3).textContent = item.text;
                         }
                         downloadDataCsvButton.style.display = 'block';
                         downloadDataCsvButton.disabled = false;
                    }
                }

                // --- Search Simulation (Repeated) ---
                if (actualNumEntries > 0) {
                    // No progress update before search
                    const searchTermLower = SEARCH_TERM.toLowerCase();

                    for (let run = 0; run < reps; run++) {
                        // Removed intermittent progress update during search runs
                        let matchCount = 0;
                        const searchStartTime = performance.now();
                        for (let i = 0; i < actualNumEntries; i++) {
                            // Simple case-insensitive substring search
                            if (generatedData[i].text.toLowerCase().includes(searchTermLower)) {
                                matchCount++;
                            }
                        }
                        const searchEndTime = performance.now();
                        const duration = searchEndTime - searchStartTime; // Keep in ms
                        searchDurations.push(duration);

                        totalSearchTime += duration;
                        minSearchTime = Math.min(minSearchTime, duration);
                        maxSearchTime = Math.max(maxSearchTime, duration);
                        if (run === 0) { // Store match count from the first run
                            totalMatchesFound = matchCount;
                        }
                    }
                    if (reps > 0) {
                        avgSearchTime = totalSearchTime / reps;
                    } else {
                         avgSearchTime = 0; // Avoid division by zero if reps = 0 somehow
                         minSearchTime = 0;
                         maxSearchTime = 0;
                    }

                    statusMessageDiv.innerHTML = "Benchmark complete."; // Final status update
                } else {
                     statusMessageDiv.innerHTML = "Benchmark stopped (no data)."; // Final status update
                     totalSearchTime = 0;
                     avgSearchTime = 0;
                     minSearchTime = 0;
                     maxSearchTime = 0;
                }

                // --- Display Results (UPDATED Template with ms) ---
                resultsSection.style.display = 'block';
                resultsDiv.innerHTML = `
                    <p><strong>Target Entries (Configured):</strong> ${NUM_ENTRIES.toLocaleString()}</p>
                    <p><strong>Actual Entries Generated:</strong> ${actualNumEntries.toLocaleString()}</p>
                    <p><strong>Text Word Count Range:</strong> ${minW} - ${maxW}</p>
                    <p><strong>Searched Term (in text):</strong> "${SEARCH_TERM}"</p>
                    <p><strong>Search Repetitions:</strong> ${reps}</p>
                    <hr style="margin: 1rem 0;">
                    ${generationError ? `<p><strong class="error">Data Generation Note:</strong> Halted early.</p><p>Details: ${generationError.message}</p>` : `<p><strong>Data Generation Time:</strong> ${generationDuration.toFixed(2)} ms</p>`}
                    ${actualNumEntries > 0 ? `
                        <p><strong>Total Search Time (${reps} runs):</strong> ${totalSearchTime.toFixed(2)} ms</p>
                        <p><strong>Average Search Time:</strong> ${avgSearchTime.toFixed(2)} ms</p>
                        <p><strong>Min Search Time:</strong> ${minSearchTime.toFixed(2)} ms</p>
                        <p><strong>Max Search Time:</strong> ${maxSearchTime.toFixed(2)} ms</p>
                        <p><strong>Matches Found (per run):</strong> ${totalMatchesFound.toLocaleString()}</p>
                    ` : `
                        <p><strong>Total Search Time:</strong> N/A</p>
                        <p><strong>Average Search Time:</strong> N/A</p>
                        <p><strong>Min Search Time:</strong> N/A</p>
                        <p><strong>Max Search Time:</strong> N/A</p>
                        <p><strong>Matches Found (per run):</strong> N/A</p>
                    `}
                `;

                // --- UI Updates End ---
                runTestButton.disabled = false;
                minWordsSlider.disabled = false;
                maxWordsSlider.disabled = false;
                searchRepsSlider.disabled = false;
                numRowsInput.disabled = false;
                // downloadDataCsvButton state already handled

            }, 50); // Timeout remains useful to allow initial UI update
        }

        // --- Attach Event Listeners ---
        runTestButton.addEventListener('click', runBenchmark);
        downloadDataCsvButton.addEventListener('click', downloadDataAsCsv);

    </script>

</body>
</html>